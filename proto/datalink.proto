syntax = "proto3";

package datalink;

option go_package = "seminarska/proto/datalink;datalink";

import "razpravljalnica.proto";

enum Operation {
  Create = 0;
  Update = 1;
  Delete = 2;
}

message Message {
  int32 message_index = 1;
  string request_id = 2; // used to identify the message independently of its index (which is not immediately known)
  Operation op = 3;
  oneof payload {
    razpravljalnica.User user = 4;
    razpravljalnica.Topic topic = 5;
    razpravljalnica.Message message = 6;
    razpravljalnica.Like like = 7;
  }
}

message Confirmation {
  int32 message_index = 1;
  string request_id = 2;
  bool ok = 3;
  string error = 4;
}


message ClientHello {
  int32 last_conf_index = 1;
}

message ClientSync {
  repeated Message messages = 1;
}

message DatabaseSnapshot {
  int32 op_count = 1;
  repeated razpravljalnica.User users = 2;
  repeated razpravljalnica.Topic topics = 3;
  repeated razpravljalnica.Message messages = 4;
  repeated razpravljalnica.Like likes = 5;
  repeated Message pending_requests = 6;
}

message ServerHelo {
  int32 last_msg_index = 1;
  bool request_transfer = 2;
}

message ServerSync {
  repeated Confirmation confirmations = 1;
}

message ClientHandshakeMsg {
  oneof payload {
    ClientHello hello = 1;
    ClientSync sync = 2;
    DatabaseSnapshot db = 3;
  }
}

message ServerHandshakeMsg {
  oneof payload {
    ServerHelo hello = 1;
    ServerSync sync = 2;
  }
}

service DataLink {
  rpc Handshake(stream ClientHandshakeMsg) returns (stream ServerHandshakeMsg);
  rpc Replicate(stream Message) returns (stream Confirmation);
}
